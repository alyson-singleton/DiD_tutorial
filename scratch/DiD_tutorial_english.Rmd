---
title: "Difference-in-differences (DiD)"
author: "Alyson (Aly) Singleton"
date: "August 2025"
output:
  html_document: default
  word_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

## Libraries

Install and load necessary libraries. We will use the *fixest* package in R throughout this tutorial, which is a very common package for working with panel data.

```{r}
library(ggplot2)
library(dplyr)
library(fixest)
# you can find nice fixest documentation here:
# https://lrberge.github.io/fixest/articles/fixest_walkthrough.html#instrumental-variables    
```

## Load data

First, load in the two necessary datasets (one for dengue and one for leish). These are the cleaned datasets with all pre-processing done. They are the datasets used in the main analysis of Singleton et al., 2025 (i.e., some health facilities are removed, see Figure 1). You can reference the full repository for data processing steps. This example workflow will use the dengue data, but you can switch out for leish data if you want.

```{r}
dengue_tutorial_df <- readRDS("./scratch/dengue_tutorial_df_english.rds")
leish_tutorial_df <- readRDS("./scratch/leish_tutorial_df_english.rds")
```

## Explore data

Let's look at the structure of the data. You can see the data is in long format, where we have a time column (year) and a unit column (e_salud).

```{r}
# look at column names and data structure
colnames(dengue_tutorial_df)
head(dengue_tutorial_df)
View(dengue_tutorial_df)

# this shows we have 81 units for each time period
table(dengue_tutorial_df$year)
# this shows we have 23 years for each health facility
table(dengue_tutorial_df$key)

# look at "treatment" distribution for one year 
#   (treatment assignment is stable throughout study period)
tx_col <- dengue_tutorial_df %>% 
  filter(year == "2001") %>%
  select(fivekm, key)
# this shows that 45 of our units are labeled as "treated (1)" and
#   36 are labeled as "control (0)"
table(tx_col$fivekm)
```

Take a second to explore the dengue data by plotting incidence over time. First, create a plot showing dengue incidence for each health facility over time, colored by exposure group.

```{r}
# plot incidence for each health facility across study period, color by treatment (<5km) and control (>10km)

# we want treatment to be a character vector for plotting (but numeric for running the models)
dengue_tutorial_df_plotting <- dengue_tutorial_df
dengue_tutorial_df_plotting$fivekm <- as.character(dengue_tutorial_df_plotting$fivekm) 

# incidence plot for each health facility
ggplot(dengue_tutorial_df_plotting) +
  geom_line(aes(year, incidence, group=key, color=fivekm), alpha=0.7) +
  scale_color_manual(values = c('darkblue', 'pink2'), 
                     labels = c("Control (>10km)", "Exposed (<5km)"), 
                     name="Group") +
  geom_vline(xintercept='2008',linetype='dashed') +
  xlab("Year") + ylab("Dengue\nincidence\n per 1k") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(angle = 0, vjust = 0.5))
```

Next, aggregate the exposure groups and plot mean incidence over time for each exposure group.

```{r}
# aggregate by treatment and control group and plot mean incidence rates across the study period
dengue_tutorial_df_plotting_agg <- dengue_tutorial_df %>%
  group_by(fivekm, year) %>%
  summarize(mean_incidence = mean(incidence))
dengue_tutorial_df_plotting_agg$fivekm <- as.character(dengue_tutorial_df_plotting_agg$fivekm)

# incidence plot for aggregated treatment groups
ggplot(dengue_tutorial_df_plotting_agg) +
  geom_line(aes(year, mean_incidence, group = fivekm, color=fivekm)) +
  scale_color_manual(values = c('darkblue', 'pink2'),
                     labels = c("Control (>10km)", "Exposed (<5km)"), 
                     name="Group") +
  geom_vline(xintercept='2008',linetype='dashed') +
  xlab("Year") + ylab("Dengue\nincidence\n per 1k") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(angle = 0, vjust = 0.5))
```

## Build simple model

Let's start with the simplest DiD model possible: only including the interaction term that compares the treatment and control group within each year to their difference in our reference year (2008). There are currently no fixed effects and no control variables. Here, $i(year, fivekm, ref = '2008')$ creates a set of interaction terms: a binary (dummy) variable for each year interacted with the treatment column ('fivekm'), but excluding year 2008 as the reference.

```{r}
# run model
dengue_tutorial_df_model_simple <- feols(
  incidence ~ i(year, fivekm, ref = '2008'), # time*treatment interaction
  data = dengue_tutorial_df)

# look at output
summary(dengue_tutorial_df_model_simple)
#fixest function to create a table with standard formatting
etable(dengue_tutorial_df_model_simple) 
#fixest function to create a figure for time*treatment interaction terms
iplot(dengue_tutorial_df_model_simple, 
              main = "Effect on dengue incidence",
              xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Add fixed effects

Now let's add unit and year fixed effects to our model. As a reminder, unit fixed effects control for time-invariant, facility-level characteristics (baseline dengue burden, suitability for vectors, etc.). The year fixed effects control for common annual changes that impact all health facilities simultaneously (particularly rainy year, change in national/regional politics, etc.). What changes do you notice?

```{r}
# run model
dengue_tutorial_df_model_FEs <- feols(
  incidence ~ i(year, fivekm, ref = '2008') | # time*treatment interaction
    key + year, # fixed effects
  data = dengue_tutorial_df)

# look at output
summary(dengue_tutorial_df_model_FEs)
etable(dengue_tutorial_df_model_FEs)
iplot(dengue_tutorial_df_model_FEs, 
      main = "Effect on dengue incidence",
      xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Full model (FEs + controls)

Finally, let's add in control variables. Here, we include urban area, agricultural area, precipitation, temperature, and temperature\^2. Do you notice any changes?

```{r}
# run model
dengue_tutorial_df_model_full <- feols(
  incidence ~ i(year, fivekm, ref = '2008') + # time*treatment interaction
    urban + ag + sum_precip_centered + #controls
    mean_temp_centered + mean_temp_centered_sq | 
    key + year, # fixed effects
  data = dengue_tutorial_df)

# look at output
summary(dengue_tutorial_df_model_full)
etable(dengue_tutorial_df_model_full)
iplot(dengue_tutorial_df_model_full, 
      main = "Effect on dengue incidence",
      xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Long difference model

Extra: Here is the code for estimating the overall treatment effect across the whole time period, instead of one effect estimate for every year. This is called a long difference model.

The main change is how we construct the 'time' column. To build the long difference model, we create a new 'time' column so that the year 2008 is 0 (our reference year) and all other years after 2008 are 1. We remove the years before 2008 because we want our control to only be 2008 (not 2000-2008). This compares the entire group of years post paving to our reference year, rather than comparing each to the reference year one at a time.

```{r}
# create new treatment variable for long difference model
dengue_df_agg <- dengue_tutorial_df %>%
  filter(year %in% as.character(c(2008:2022))) %>%
  mutate(year_binary = if_else(year == "2008", 0, 1))

# run model
dengue_long_difference_model <- feols(
  incidence ~ year_binary * fivekm + # time*treatment interaction
    urban + ag + sum_precip_centered + #controls
    mean_temp_centered + mean_temp_centered_sq | 
    key + year_binary, # fixed effects
  data = dengue_df_agg)

# look at output
summary(dengue_long_difference_model)
etable(dengue_long_difference_model)

# our average treatment effect across the time period
coef(dengue_long_difference_model)[6]
```

If you have extra time, you can try running the models for leishmaniasis as well! Alternatively, you can look through the full GitHub code and try out some of the other models, such as the biannual (**code/07_main_models_fixest.R**) or distance heterogeneity analyses (**code/10_distance_het_models.R**). Note you will have to download the full dataset to build the distance heterogeneity models. Project repository here: https://github.com/alyson-singleton/IOH_and_dengue.
